<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">

<dom-module id="cz-words-dash">

  <template>
    <style>

      paper-card .card-flex {
        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
      }

      paper-item {
        box-sizing: border-box;
        padding-bottom: 10px;
      }

      .avatar {
        display: inline-block;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        overflow: hidden;
        background: #ccc;
      }

      paper-badge {
        --paper-badge-background: var(--paper-blue-300);
      }
    </style>
      <paper-card id='card' heading='Bad Word Detector'>
        <div class="card-content">
          <template is="dom-repeat" items="{{users}}"
                    observe="data" sort="sortUsers">
            <template is="dom-if" if="{{count(item.data)}}">
              <paper-item>
                <paper-item-body>
                  <div><b>{{item.user}}</b>
                    <div inner-h-t-m-l={{tooltip(item.data)}}></div>
                  </div>
                </paper-item-body>
              </paper-item>
            </template>
          </template>

          <paper-item>
            <paper-item-body>
              <template is="dom-if" if="{{count(blinkDev)}}"
                <div><b>blink-dev</b>
                  <div inner-h-t-m-l={{tooltip(blinkDev)}}></div>
                </div>
              </template>
            </paper-item-body?
          <paper-item>

        </div>
      </paper-card>
  </template>
  <script>
    Polymer({
      is: "cz-words-dash",

      properties: {
        users: {
          type: 'Object',
          value: function() { return []; },
          observer: "usersChanged",
        },
        blinkDev: {
          type: 'Object',
          value: function() { return []; },
        }
      },

      sortUsers: function(a, b) {
        if (a.user < b.user)
          return -1;
        if (a.user > b.user)
          return 1;
        return 0;
      },

      count: function(data) {
        return data ? data.length : false;
      },

      tooltip: function(data) {
        return data.map(report => {
          let result = `<a href=${report.url}>${report.title}</a><br> `;
          var fragments = [];
          report.strings.forEach(({string, positions}) => {
            for (var i = 0; i < positions.length; i++) {
              var position = positions[i];
              var windowStart = Math.max(position - 50, 0);
              if (windowStart > 0 && string[windowStart - 1] !== ' ') {
                var newStart = string.indexOf(' ', windowStart);
                if (newStart == -1)
                  newStart = string.lastIndexOf(' ', newStart);
                  if (newStart == -1)
                    newStart = 0;
                windowStart = newStart;
              } else {
              }
              var startEllipsis = windowStart == 0 ? '' : '...';

              var windowEnd = Math.min(windowStart + 100, string.length);
              if (windowEnd < string.length && !'. '.includes(string[windowEnd] !== ' ')) {
                while (string[windowEnd] !== ' ')
                  windowEnd--;
                var endEllipsis = '...';
              } else {
                var endEllipsis = '';
              }

              while (i < positions.length - 1 && positions[i] < windowEnd)
                i++;
              var fragment = string.substring(windowStart, windowEnd);
              fragment = fragment.replace(/\</g, "&lt;");
              if (fragments.includes(fragment))
                continue;
              fragments.push(fragment);
              result += `${startEllipsis}${fragment}${endEllipsis}<br>`;
            }
          });
          return result;}).join('');
      },

      attached: function() {
        registerSource('cz-config', 'users', function(users) {
          this.set('users', users);
        }.bind(this));
        registerSource('cz-word-detector', {component: 'cz-mailing-list', query: {list: 'blink-dev'}}, function(data) {
          this.set('blinkDev', data);
        }.bind(this));
      },

      usersChanged: function(users) {
        // TODO: this probably only works for all-or-nothing changes to users right now.
        var count = 0;
        users.forEach(function(user, idx) {
          registerSource('cz-word-detector', {component: 'cz-gerrit-strings', query: {user: user.user, email: user.email}}, function(data) {
            this.set('users.' + idx + '.data', data);
          }.bind(this));
        }.bind(this));
      }
    });
  </script>
</dom-module>
